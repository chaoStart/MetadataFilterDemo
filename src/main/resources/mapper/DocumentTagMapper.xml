<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.springsciyon.business.rag.dao.DocumentTagMapper">

    <!-- 查询文档数量和最后更新时间 -->
    <select id="selectCountAndMaxTime" resultType="map">
        SELECT COUNT(*) AS c,
        IFNULL(MAX(update_time), 0) AS t
        FROM DocumentTag
    </select>

<!--    &lt;!&ndash; 查询 doc_id、file_name、metadata_list &ndash;&gt;-->
<!--    <select id="selectSimpleInfo" resultType="com.springsciyon.business.rag.entity.DocumentTagEntity">-->
<!--        SELECT doc_id,-->
<!--        file_name,-->
<!--        metadata_list-->
<!--        FROM DocumentTag-->
<!--    </select>-->
    <select id="selectSimpleInfo" resultMap="DocumentTagSimpleMap">
        SELECT doc_id,
        file_name,
        metadata_list
        FROM DocumentTag
    </select>

    <resultMap id="DocumentTagSimpleMap"
               type="com.springsciyon.business.rag.entity.DocumentTagEntity">
        <id column="doc_id" property="docId"/>
        <result column="file_name" property="fileName"/>
        <result column="metadata_list" property="metadataList"
                typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
    </resultMap>

    <!-- 插入或更新（ON DUPLICATE KEY UPDATE） -->
    <insert id="insertOrUpdate"
            parameterType="com.springsciyon.business.rag.entity.DocumentTagEntity">
        INSERT INTO DocumentTag
        (doc_id, file_name, author, date_time, metadata_list)
        VALUES
        (#{docId},
        #{fileName},
        #{author},
        #{dateTime},
        #{metadataList,
          typeHandler=com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler})
        ON DUPLICATE KEY UPDATE
        file_name = VALUES(file_name),
        author = VALUES(author),
        date_time = VALUES(date_time),
        metadata_list = VALUES(metadata_list)
    </insert>

</mapper>
